<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CanX</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo.png') }}" />
    <link rel="stylesheet" href="/static/css/styles.css" />
    <link rel="stylesheet" href="/static/css/graphic.css" />
  </head>
  <body>
    <header>
      <div class="header-top">
        <a class="home-btn" href="/" aria-label="CanX home">
          <img src="{{ url_for('static', filename='img/logo.png') }}" alt="CanX logo" />
          <span>CanX</span>
        </a>
        <div class="connection-actions" role="group" aria-label="Connection controls">
          <button id="btn-connection-toggle" type="button" aria-pressed="false">Connect</button>
          <button id="btn-log-toggle" type="button" aria-pressed="false">Start Log</button>
        </div>
      </div>
      <nav>
        <button class="tab-btn active" data-tab="trace">Trace</button>
        <button class="tab-btn" data-tab="log">Log</button>
        <button class="tab-btn" data-tab="messages">Messages</button>
        <button class="tab-btn" data-tab="stim">Stimulation</button>
        <button class="tab-btn" data-tab="diag">Diagnostics</button>
        <button class="tab-btn" data-tab="graphic">Graphic</button>
        <button class="tab-btn" data-tab="panel">Panel</button>
        <button class="tab-btn" data-tab="settings">Settings</button>
      </nav>
    </header>

    <main>
      <section id="tab-trace" class="tab active">
        <div class="toolbar">
          <button id="btn-trace-clear" type="button">Clear Trace</button>
          <label>Filter ID <input id="trace-filter" type="text" placeholder="e.g. 7E0 or 0x7E0" /></label>
          <span id="trace-status" class="status" role="status" aria-live="polite"></span>
        </div>
        <table id="trace-table">
          <thead>
            <tr>
              <th>Δt (s)</th>
              <th>Direction</th>
              <th>Frame</th>
              <th>ID</th>
              <th>Frame Name</th>
              <th>DLC</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="tab-log" class="tab">
        <div class="toolbar">
          <button id="btn-log-clear" type="button">Clear Log</button>
          <label>Filter ID <input id="log-filter" type="text" placeholder="e.g. 7E0 or 0x7E0" /></label>
          <span id="log-status" class="status" role="status" aria-live="polite"></span>
        </div>
        <table id="log-table">
          <thead>
            <tr>
              <th>Time (s)</th>
              <th>Direction</th>
              <th>Frame</th>
              <th>ID</th>
              <th>Frame Name</th>
              <th>DLC</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section id="tab-messages" class="tab">
        <div class="split">
          <div class="left">
            <div class="toolbar">
              <button id="btn-load-dbc">Load DBC Messages</button>
              <input id="msg-search" type="text" placeholder="Search message" />
            </div>
            <ul id="msg-list"></ul>
          </div>
          <div class="right">
            <div id="msg-details">
              <h3 id="msg-title">Select a message</h3>
              <div class="toolbar">
                <label>Period (ms) <input id="msg-period" type="number" value="100" /></label>
                <label>Duration (ms) <input id="msg-duration" type="number" placeholder="(optional)" /></label>
                <button id="btn-update-signals">Update</button>
                <button id="btn-toggle-periodic" class="toggle-btn">Activate</button>
                <button id="btn-remove-message">Remove</button>
                <span id="msg-status" class="stim-status"></span>
              </div>
              <form id="signals-form"></form>
              <div id="msg-meta"></div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-stim" class="tab">
        <div class="toolbar">
          <select id="stim-node-select"></select>
          <button id="btn-stim-add">Add Node</button>
          <span id="stim-status"></span>
        </div>
        <div id="stim-nodes-container"></div>
      </section>

      <section id="tab-diag" class="tab">
        <div class="diag-log" id="diag-log"></div>

        <div class="diag-request-card">
          <div class="diag-request-row">
            <label class="diag-inline-label">
              Request (HEX)
              <textarea id="diag-request-raw" rows="2" wrap="soft" placeholder="e.g. 10 01"></textarea>
            </label>
            <button id="btn-diag-send" type="button">Send</button>
          </div>
          <div class="diag-request-actions">
            <button id="btn-diag-add" class="diag-add-btn" type="button">Add</button>
            <div class="diag-address-toggle">
              <span id="diag-address-label">Functional</span>
              <label class="settings-toggle" aria-label="Toggle between Functional and Physical">
                <input id="diag-address-toggle" type="checkbox" aria-checked="false" />
                <span class="settings-toggle-track" aria-hidden="true">
                  <span class="settings-toggle-thumb"></span>
                </span>
              </label>
              <span class="diag-address-label">Physical</span>
            </div>
          </div>
        </div>

        <div class="diag-footer">
          <div class="diag-footer-group diag-fast-group">
            <div class="diag-fast-grid" id="diag-fast-buttons"></div>
          </div>
          <div class="diag-footer-group diag-middle-group">
            <div class="diag-footer-row diag-middle-row">
              <button id="btn-diag-unlock" type="button">Unlock Security</button>
              <button id="btn-tp-toggle" class="toggle-btn tp-toggle" type="button" aria-pressed="false">Start TP</button>
            </div>
            <div class="diag-footer-row diag-did-row">
              <label class="diag-inline-label" for="diag-did-value">Value (uint8)</label>
              <input id="diag-did-value" type="number" min="0" max="255" value="0" />
              <button id="btn-diag-send-did" type="button">Send DID Value</button>
            </div>
          </div>
          <div class="diag-footer-group diag-custom-group">
            <div class="diag-custom" id="diag-custom-buttons"></div>
          </div>
        </div>
      </section>

      <section id="tab-graphic" class="tab">
        <div class="graphic-wrapper">
          <div class="graphic-stage-column">
            <div class="graphic-stage-header">
              <div>
                <h3>Graphic View</h3>
                <div class="graphic-mode-toggle" role="radiogroup" aria-label="Graph style">
                  <label>
                    <input type="radio" name="graphic-mode" value="combined" checked />
                    Combined
                  </label>
                  <label>
                    <input type="radio" name="graphic-mode" value="separate" />
                    Separate
                  </label>
                </div>
              </div>
              <div class="graphic-main-actions">
                <span id="graphic-pause-indicator" class="graphic-pause-indicator" aria-hidden="true">Paused</span>
                <button id="graphic-pause" type="button">Pause</button>
              </div>
            </div>
            <div class="graphic-controls-row">
              <div class="graphic-scale-readout" aria-live="polite">
                <div>
                  <span>Time / div</span>
                  <strong id="graphic-time-scale">—</strong>
                </div>
                <div>
                  <span>Vertical zoom</span>
                  <strong id="graphic-value-scale">—</strong>
                </div>
              </div>
              <div class="graphic-zoom-controls" aria-label="Time axis zoom controls">
                <button id="graphic-zoom-out" type="button" aria-label="Zoom out time axis">−</button>
                <button id="graphic-zoom-in" type="button" aria-label="Zoom in time axis">+</button>
                <button id="graphic-zoom-reset" type="button">Reset</button>
                <button id="graphic-zoom-auto" type="button">Auto</button>
                <div class="graphic-cursor-controls">
                  <button id="graphic-cursor-toggle" type="button" aria-pressed="false">Cursors</button>
                  <span id="graphic-cursor-delta" class="graphic-cursor-delta" aria-live="polite">Δt —</span>
                </div>
              </div>
            </div>
            <div class="graphic-stage" id="graphic-stage">
              <div class="graphic-canvas is-active" id="graphic-combined" aria-label="Signal oscilloscope view">
                <canvas id="graphic-combined-canvas"></canvas>
                <div id="graphic-placeholder" aria-live="polite">Select signals to render them here.</div>
              </div>
              <div id="graphic-separate-container" class="graphic-separate-container"></div>
            </div>
            <p class="graphic-stage-hint">
              Scroll vertically to adjust amplitude, horizontally to change the time base. Drag to pan while paused.
            </p>
          </div>
          <aside class="graphic-sidebar" aria-label="Signal browser and legend">
            <div class="graphic-sidebar-section graphic-search-section">
              <div class="graphic-search-bar">
                <input
                  id="graphic-search"
                  type="text"
                  placeholder="Search signal or message"
                  autocomplete="off"
                />
                <button id="btn-graphic-refresh" type="button">Reload</button>
              </div>
              <ul id="graphic-results" class="graphic-result-list"></ul>
            </div>
            <div class="graphic-sidebar-section graphic-selected-section">
              <h3>Selected Signals</h3>
              <ul id="graphic-selected" class="graphic-selected-list"></ul>
            </div>
            <div id="graphic-status" class="graphic-status" role="status" aria-live="polite"></div>
          </aside>
        </div>
      </section>

      <section id="tab-panel" class="tab">
          <div id="panel-layout">
          <div id="panel-ribbon-stack">
            <div class="panel-ribbon panel-main-ribbon">
              <div class="panel-ribbon-group panel-mode-group">
                <div class="panel-ribbon-button-block">
                  <button
                    id="panel-run-mode"
                    class="panel-ribbon-button panel-ribbon-button--mode"
                    type="button"
                    aria-label="Running"
                  >
                    <span class="panel-ribbon-icon panel-icon-running" aria-hidden="true"></span>
                  </button>
                  <span class="panel-ribbon-label">Running</span>
                </div>
              </div>

              <div class="panel-ribbon-group panel-io-group" data-mode="edit">
                <div class="panel-ribbon-group-title">Export / Import</div>
                <div class="panel-ribbon-stack-buttons">
                  <div class="panel-ribbon-button-block">
                    <button
                      id="panel-export"
                      class="panel-ribbon-button panel-ribbon-button--export"
                      type="button"
                      aria-label="Export"
                    >
                      <span class="panel-ribbon-icon panel-icon-export" aria-hidden="true"></span>
                    </button>
                    <span class="panel-ribbon-label">Export</span>
                  </div>
                  <div class="panel-ribbon-button-block">
                    <button
                      id="panel-import"
                      class="panel-ribbon-button panel-ribbon-button--import"
                      type="button"
                      aria-label="Import"
                    >
                      <span class="panel-ribbon-icon panel-icon-import" aria-hidden="true"></span>
                    </button>
                    <span class="panel-ribbon-label">Import</span>
                  </div>
                  <input id="panel-import-file" type="file" hidden accept="application/json" />
                </div>
              </div>

              <div class="panel-ribbon-group panel-clear-group" data-mode="edit">
                <div class="panel-ribbon-stack-buttons">
                  <div class="panel-ribbon-button-block">
                    <button
                      id="panel-clear"
                      class="panel-ribbon-button"
                      type="button"
                      aria-label="Clear All"
                    >
                      <span class="panel-ribbon-icon panel-icon-clear" aria-hidden="true"></span>
                    </button>
                    <span class="panel-ribbon-label">Clear All</span>
                  </div>
                  <div class="panel-ribbon-button-block">
                    <button
                      id="panel-script-toggle"
                      class="panel-ribbon-button"
                      type="button"
                      aria-label="Default Mode"
                    >
                      <span class="panel-ribbon-icon panel-icon-default" aria-hidden="true"></span>
                    </button>
                    <span class="panel-ribbon-label">Default Mode</span>
                  </div>
                </div>
              </div>

              <div class="panel-ribbon-group panel-toolbox-group" data-mode="edit">
                <div class="panel-ribbon-group-title">Toolbox</div>
                <div class="panel-toolbox-dropdown">
                  <div id="panel-toolbox" class="panel-toolbox-menu"></div>
                </div>
                <div class="panel-layout-grid">
                  <label>Col <input id="panel-layout-col" type="number" /></label>
                  <label>Row <input id="panel-layout-row" type="number" /></label>
                  <label>W <input id="panel-layout-width" type="number" /></label>
                  <label>H <input id="panel-layout-height" type="number" /></label>
                </div>
                <div class="panel-map-row">
                  <label>
                    MESSAGE
                    <input id="panel-map-message" type="text" />
                  </label>
                  <label>
                    SIGNAL
                    <input id="panel-map-signal" type="text" />
                  </label>
                </div>
              </div>

              <div class="panel-ribbon-group panel-object-properties-group" data-mode="edit">
                <div class="default-properties-group">
                  <div id="panel-properties"></div>
                </div>

                <div class="script-editor-group">
                  <div class="panel-field panel-script-field">
                    <label class="panel-script-label">SCRIPT</label>
                    <textarea id="panel-script-editor" class="panel-script-input"></textarea>
                  </div>
                </div>
              </div>

              <div class="panel-ribbon-group panel-name-description-group panel-name-group">
                <input id="panel-name" type="text" placeholder="Panel Name" />
                <div id="panel-widget-description" class="panel-toolbox-description" hidden></div>
              </div>
            </div>
          </div>

          <div id="panel-canvas-container">
            <div id="panel-canvas"></div>
          </div>
        </div>
      </section>

      <section id="tab-settings" class="tab">
        <div class="settings-grid">
          <div class="settings-card">
            <div class="settings-card-header">
              <h3>Device Configuration</h3>
              <p>Choose the CAN interface and defaults.</p>
            </div>
            <div class="settings-fields">
              <label>Device
                <select id="device">
                  <option value="PCAN">PCAN</option>
                  <option value="CANalyzer">CANalyzer</option>
                  <option value="CANoe">CANoe</option>
                  <option value="CANape">CANape</option>
                  <option value="VirtualCAN">VirtualCAN</option>
                  <option value="MockCAN">MockCAN</option>
                </select>
              </label>
              <div class="settings-inline channel-padding-row">
                <label>Channel
                  <input id="channel" type="number" value="0" min="0" />
                </label>
                <label>Padding
                  <input id="padding" type="text" value="00" size="3" />
                </label>
              </div>
              <div class="mode-field">
                <span class="mode-label">Mode</span>
                <div class="mode-options" role="radiogroup" aria-label="Bus mode">
                  <label>
                    <input type="radio" name="bus-mode" value="can" checked /> CAN
                  </label>
                  <label>
                    <input type="radio" name="bus-mode" value="iso-can-fd" /> ISO CAN FD
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <h3>DBC</h3>
              <p>Select and upload your DBC file.</p>
            </div>
            <div class="settings-fields">
              <label class="wide">DBC Path
                <div class="picker-row">
                  <input id="dbc_path" type="text" placeholder="path/to/file.dbc" />
                  <button id="btn-dbc-browse" type="button">Browse…</button>
                </div>
                <input id="dbc-file" type="file" accept=".dbc" hidden />
              </label>
              <div class="settings-inline dbc-node-row">
                <label>Node
                  <input id="dbc-node" type="text" placeholder="e.g. CGW_CCU" />
                </label>
                <label class="settings-toggle" aria-label="Activate all receiver messages">
                  <input id="receiver-activate-all" type="checkbox" checked />
                  <span class="settings-toggle-track" aria-hidden="true">
                    <span class="settings-toggle-thumb"></span>
                  </span>
                </label>
              </div>
              <p class="field-note dbc-node-note">All messages this node receives will auto-activate when active.</p>
            </div>
          </div>

          <div class="settings-card settings-actions">
            <div class="settings-card-header">
              <h3>Actions</h3>
              <p>Apply configuration and prepare message defaults.</p>
            </div>
            <div class="init-actions">
              <button id="btn-reset-signals" type="button" disabled>Initialize</button>
            </div>
            <span id="init-status" class="init-status" role="status" aria-live="polite"></span>
          </div>

          <div class="settings-card">
            <div class="settings-card-header">
              <h3>Diagnostics</h3>
              <p>Configure IDs, timeouts, and security helper settings.</p>
            </div>
            <div class="settings-fields diag-settings-grid">
              <div class="settings-inline diag-inline">
                <label>Functional ID
                  <input id="diag-functional-id" type="text" value="7DF" />
                </label>
                <label>Timeout (ms)
                  <input id="diag-functional-timeout" type="number" value="500" />
                </label>
              </div>
              <div class="settings-inline diag-inline">
                <label>Physical ID
                  <input id="diag-physical-id" type="text" value="7E0" />
                </label>
                <label>Timeout (ms)
                  <input id="diag-physical-timeout" type="number" value="500" />
                </label>
              </div>
              <div class="settings-inline diag-inline">
                <label>Tester ID
                  <input id="tester-id" type="text" value="7E8" />
                </label>
                <label>Tester Present Interval (ms)
                  <input id="tp-interval" type="number" value="2000" />
                </label>
              </div>
              <div class="diag-dll-picker">
                <label class="wide">Security DLL
                  <div class="picker-row">
                    <input id="diag-dll" type="text" placeholder="path/to/security.dll" />
                    <button id="btn-dll-browse" type="button">Browse…</button>
                  </div>
                  <input id="diag-dll-file" type="file" accept=".dll" hidden />
                </label>
              </div>
            </div>
          </div>
          <div class="settings-card">
            <div class="settings-card-header">
              <h3>Profiles</h3>
              <p>Export or import settings, message values, and panels.</p>
            </div>
            <div class="settings-fields profile-actions">
              <button id="profile-export" type="button">Export Profile</button>
              <button id="profile-import" type="button">Import Profile</button>
              <input id="profile-import-file" type="file" accept="application/json" hidden />
            </div>
            <p class="field-note">Profiles include message overrides, settings, and panel layouts.</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="app-footer" aria-label="Status bar">
      <div class="footer-spacer" aria-hidden="true"></div>
      <div class="footer-slot">
        <span class="footer-label">Device</span>
        <span id="device-status" class="footer-value" aria-live="polite">Disconnected</span>
      </div>
      <div class="footer-slot">
        <span class="footer-label">DBC</span>
        <span id="dbc-status" class="footer-value" aria-live="polite">Not loaded</span>
      </div>
      <div class="footer-slot">
        <span class="footer-label">Diagnostics</span>
        <span id="diag-status" class="footer-value" aria-live="polite">Not configured</span>
      </div>
      <div class="footer-slot">
        <span class="footer-label">Socket</span>
        <span id="socket-status" class="footer-value" role="alert" aria-live="polite">Idle</span>
      </div>
      <div class="footer-slot">
        <span class="footer-label">Bus Load</span>
        <span id="busload-status" class="footer-value" aria-live="polite" data-rate-kbps="500">—</span>
      </div>
    </footer>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
    <script type="module" src="/static/js/main.js"></script>
    <script type="module" src="/static/js/panel.js"></script>
  </body>
  </html>
